<!DOCTYPE html>
<html>
  <head>
    <meta
      charset="utf-8"
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>Kakao 지도 시작하기</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a6546188cab40bea0d30c30a1d2c578d&libraries=services"></script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 100vh"></div>
    <script>
        const arr = []; // 가게 주소를 넣음
        const customOverlayName = []; // customOverlay 변수를 추가
        for (const req of deliveryRequests) {
          // 존재하지 않는다면 arr에 추가
          if (arr.indexOf(req.storeAddress) === -1) {
            arr.push(req.storeAddress);
            // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
            const contentForRider = '<div style="padding:5px; width:fit-content; height:100%; background-color:white; border-radius:10px; border: 1px solid lightblue; box-shadow: 2px 2px 2px #60b6f7;">' + req.storeName + '<br>' + req.deliveryPay + '원<br>' + req.distanceFromStoreToRider + 'km</div>'

            const markerPosition = new kakao.maps.LatLng(req.storeLatitude, req.storeLongitude); //인포윈도우 표시 위치입니다
            // 마커를 생성합니다
            const marker = new kakao.maps.Marker({
                position: markerPosition,
                clickable: true
            });
            // 마커가 지도 위에 표시되도록 설정합니다
            marker.setMap(map);

            // 라이더 커스텀 오버레이 셋업, 나중에 주소가 같으면 content를 수정할 수 있게끔 변수명을 indexing 처리
            customOverlayName[arr.length-1] = new kakao.maps.CustomOverlay({
              position: markerPosition,
              content: contentForRider,
              yAnchor: 1.6,
            });

            // const customOverlayForRider = new kakao.maps.CustomOverlay({
            //   position: markerPosition,
            //   content: contentForRider,
            //   yAnchor: 1.6,
            // });

            // 라이더 커스텀 오버레이 지도 위에 띄우기
            customOverlayName[arr.length-1].setMap(map);

            // 마커를 눌렀을 때 배달 신청 확인 창 뜨기
            kakao.maps.event.addListener(marker, 'click', function() {
              window.ReactNativeWebView.postMessage(JSON.stringify(req));
            });
          } else {
            const contentForRider = '<br><div style="padding:5px; width:fit-content; height:100%; background-color:white; border-radius:10px; border: 1px solid lightblue; box-shadow: 2px 2px 2px #60b6f7;">' + req.storeName + '<br>' + req.deliveryPay + '원<br>' + req.distanceFromStoreToRider + 'km</div>'
            const newContent = customOverlayName[arr.indexOf(req.storeAddress)].getContent() + contentForRider;
            console.log(newContent);
            customOverlayName[arr.indexOf(req.storeAddress)].setContent(newContent);
          }
        };
      const imageSrc = '${localImage}', // 마커이미지의 주소입니다
        imageSize = new kakao.maps.Size(53, 50), // 마커이미지의 크기입니다
        imageOption = {offset: new kakao.maps.Point(27, 69)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.

      // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
      const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
          markerPosition = new kakao.maps.LatLng(${
            location.coords.latitude
          }, ${location.coords.longitude}); // 마커가 표시될 위치입니다
      // 마커를 생성합니다
      const marker = new kakao.maps.Marker({
          position: markerPosition,
          image: markerImage // 마커이미지 설정
      });
      marker.setMap(map);
    </script>
    <div
      style="
        padding: 5px;
        width: fit-content;
        height: 100%;
        background-color: white;
        border-radius: 10px;
        border: 1px solid lightblue;
        box-shadow: 2px 2px 2px #60b6f7;
      "
    >
      ' + req.storeName + '<br />' + req.distanceFromStoreToRider + 'km<br />' +
      req.deliveryPay + '원
      <button style="margin-left: 10px" onclick="onClick()">수락</button>
    </div>
    <div style="margin-top: 10px">
      ' + req.deliveryPay + '원
      <button style="margin-left: 10px" onclick="onClick()">수락</button>
    </div>
  </body>
</html>
